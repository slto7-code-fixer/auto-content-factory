name: Auto Content Factory

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      content_topic:
        description: 'Topic for content generation'
        required: false
        default: 'technology'

jobs:
  generate_content:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          pyproject.toml
          setup.py

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg imagemagick ghostscript libsm6 libxext6
        # Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ImageMagick policy
        if [ -f /etc/ImageMagick-6/policy.xml ]; then
          sudo sed -i 's/<policy domain="coder" rights="none" pattern="PDF" \/>/<policy domain="coder" rights="read|write" pattern="PDF" \/>/g' /etc/ImageMagick-6/policy.xml
        fi

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          # ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ requirements.txt
          pip install moviepy>=1.0.3 gTTS>=2.3.2 pydub>=0.25.1 openai>=1.6.1 pillow>=10.0.0 requests>=2.31.0
          pip install pyyaml>=6.0 python-dotenv>=1.0.0 numpy>=1.24.0
        fi

    - name: Setup environment
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
        mkdir -p output/videos output/audio output/text logs
        
        # Ù†Ø³Ø® Ù…Ù„Ù .env Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ ÙƒÙ†Ù…ÙˆØ°Ø¬
        if [ -f .env.example ] && [ ! -f .env ]; then
          cp .env.example .env
          echo "Copied .env.example to .env"
        fi

    - name: Validate environment
      run: |
        echo "Python version: $(python --version)"
        echo "Pip version: $(pip --version)"
        echo "FFmpeg version: $(ffmpeg -version 2>/dev/null | head -n1 || echo 'FFmpeg not found')"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙØ§Øª Python Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if [ ! -f "agents/script_agent.py" ]; then
          echo "ERROR: script_agent.py not found!"
          exit 1
        fi
        if [ ! -f "agents/voice_agent.py" ]; then
          echo "ERROR: voice_agent.py not found!"
          exit 1
        fi
        if [ ! -f "agents/video_agent.py" ]; then
          echo "ERROR: video_agent.py not found!"
          exit 1
        fi
        if [ ! -f "main.py" ]; then
          echo "ERROR: main.py not found!"
          exit 1
        fi

    - name: Generate content
      env:
        CONTENT_TOPIC: ${{ github.event.inputs.content_topic || 'technology' }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || '' }}
        ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY || '' }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY || '' }}
      run: |
        set -e  # Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø£ÙŠ Ø®Ø·Ø£
        
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        LOG_FILE="logs/run_${TIMESTAMP}.log"
        
        echo "=== Auto Content Factory ===" | tee -a "$LOG_FILE"
        echo "Run ID: ${{ github.run_id }}" | tee -a "$LOG_FILE"
        echo "Topic: $CONTENT_TOPIC" | tee -a "$LOG_FILE"
        echo "Start time: $(date)" | tee -a "$LOG_FILE"
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø¨ØªØ³Ù„Ø³Ù„ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        echo "Step 1/4: Generating script..." | tee -a "$LOG_FILE"
        python agents/script_agent.py "$CONTENT_TOPIC" 2>&1 | tee -a logs/script_${TIMESTAMP}.log
        
        echo "Step 2/4: Generating voice..." | tee -a "$LOG_FILE"
        python agents/voice_agent.py 2>&1 | tee -a logs/voice_${TIMESTAMP}.log
        
        echo "Step 3/4: Generating video..." | tee -a "$LOG_FILE"
        python agents/video_agent.py 2>&1 | tee -a logs/video_${TIMESTAMP}.log
        
        echo "Step 4/4: Compiling final content..." | tee -a "$LOG_FILE"
        python main.py 2>&1 | tee -a logs/main_${TIMESTAMP}.log
        
        echo "End time: $(date)" | tee -a "$LOG_FILE"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
        echo "=== Output Verification ===" | tee -a "$LOG_FILE"
        if [ -f "output/final_video.mp4" ]; then
          FILESIZE=$(stat -c%s "output/final_video.mp4" 2>/dev/null || stat -f%z "output/final_video.mp4")
          echo "âœ“ Final video: output/final_video.mp4 (${FILESIZE} bytes)" | tee -a "$LOG_FILE"
        else
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡
          VIDEO_FILES=$(find output/ -name "*.mp4" -o -name "*.avi" -o -name "*.mov" 2>/dev/null | head -5)
          if [ -n "$VIDEO_FILES" ]; then
            echo "âœ“ Found video files:" | tee -a "$LOG_FILE"
            echo "$VIDEO_FILES" | tee -a "$LOG_FILE"
          else
            echo "âœ— No video files found in output/" | tee -a "$LOG_FILE"
          fi
        fi
        
        echo "=== Summary ===" | tee -a "$LOG_FILE"
        echo "Content generation completed!" | tee -a "$LOG_FILE"

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4  # ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† v3 Ø¥Ù„Ù‰ v4
      with:
        name: generated-content-${{ github.run_id }}
        path: |
          output/
          logs/
        retention-days: 7

    - name: Create GitHub Release (Optional)
      if: success() && github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      continue-on-error: true  # Ù„Ø§ ØªÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„Øª Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©
      with:
        files: output/final_video.mp4
        tag_name: content-${{ github.run_id }}
        name: "Generated Content #${{ github.run_number }}"
        body: |
          Auto-generated content
          
          **Topic:** ${{ github.event.inputs.content_topic || 'technology' }}
          **Run ID:** ${{ github.run_id }}
          **Created:** ${{ github.event.head_commit.timestamp }}
          
          [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        draft: false
        prerelease: false

    - name: Success notification
      if: success()
      run: |
        echo "âœ… Content generation completed successfully!"
        echo "ğŸ“Š View artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ Content generation failed!"
        echo "ğŸ” Check logs for details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        exit 1
