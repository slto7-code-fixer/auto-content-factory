name: Auto Content Factory

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      content_topic:
        description: 'Topic for content generation'
        required: false
        default: 'technology'

jobs:
  generate_content:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4  # ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¥ØµØ¯Ø§Ø± v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # Ø¥ØµØ¯Ø§Ø± LTS Ù…Ø¯Ø¹ÙˆÙ…
        cache: 'pip'  # ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        cache-dependency-path: |
          requirements.txt
          pyproject.toml
          setup.py

    - name: Install system dependencies (if needed)
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg imagemagick ghostscript
        # Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ImageMagick Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§
        sudo sed -i 's/<policy domain="coder" rights="none" pattern="PDF" \/>/<policy domain="coder" rights="read|write" pattern="PDF" \/>/g' /etc/ImageMagick-6/policy.xml || true

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          # Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
          pip install moviepy>=1.0.3 gTTS>=2.3.2 pydub>=0.25.1 openai>=1.6.1 pillow>=10.0.0 requests>=2.31.0
        fi
        # Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        pip install pyyaml>=6.0 python-dotenv>=1.0.0

    - name: Setup environment variables
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
        if [ ! -f .env ]; then
          cp .env.example .env 2>/dev/null || echo "No .env.example found, skipping"
        fi
        # ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
          echo "WARNING: OPENAI_API_KEY not set in secrets"
        fi

    - name: Lint and validate code
      run: |
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯
        python -m py_compile agents/*.py 2>/dev/null || true
        python -m py_compile main.py 2>/dev/null || true
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ flake8 Ø£Ùˆ black
        pip install flake8 black --quiet 2>/dev/null || true
        flake8 agents/ main.py --max-line-length=120 --ignore=E501,W503 2>/dev/null || true

    - name: Create output directories
      run: |
        mkdir -p output/videos output/audio output/text logs
        echo "Output directories created"

    - name: Generate content (with error handling)
      continue-on-error: false
      env:
        CONTENT_TOPIC: ${{ github.event.inputs.content_topic || 'technology' }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      run: |
        set -e  # Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø®Ø·Ø£
        
        # ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡
        echo "Job started at: $(date)" > logs/run_$(date +%Y%m%d_%H%M%S).log
        
        # ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨ØªØ³Ù„Ø³Ù„ Ù…Ø­Ø¯Ø¯
        echo "=== Generating Script ==="
        python agents/script_agent.py "$CONTENT_TOPIC" 2>&1 | tee -a logs/script.log
        
        echo "=== Generating Voice ==="
        python agents/voice_agent.py 2>&1 | tee -a logs/voice.log
        
        echo "=== Generating Video ==="
        python agents/video_agent.py 2>&1 | tee -a logs/video.log
        
        echo "=== Compiling Final Content ==="
        python main.py 2>&1 | tee -a logs/main.log
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®Ø±Ø¬Ø©
        if [ -f "output/final_video.mp4" ]; then
          echo "SUCCESS: Final video generated: output/final_video.mp4"
          ls -lh output/final_video.mp4
        else
          echo "WARNING: Final video not found in expected location"
          find output/ -name "*.mp4" -o -name "*.avi" -o -name "*.mov" | head -5
        fi

    - name: Upload artifacts
      if: always()  # Ø±ÙØ¹ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
      uses: actions/upload-artifact@v3
      with:
        name: generated-content-${{ github.run_id }}
        path: |
          output/
          logs/
        retention-days: 7

    - name: Upload to releases (optional)
      if: success() && github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        files: output/final_video.mp4
        tag_name: content-${{ github.run_id }}
        name: Generated Content ${{ github.run_number }}
        body: |
          Auto-generated content created on ${{ github.event.head_commit.timestamp }}
          
          Topic: ${{ github.event.inputs.content_topic || 'technology' }}
          
          Run ID: ${{ github.run_id }}
        draft: false
        prerelease: false

    - name: Notify success
      if: success()
      run: |
        echo "ğŸ‰ Content generation completed successfully!"
        echo "Run ID: ${{ github.run_id }}"
        echo "Artifacts available for download"

    - name: Notify failure
      if: failure()
      run: |
        echo "âŒ Content generation failed!"
        echo "Check the logs for details"
        echo "Run ID: ${{ github.run_id }}"
        exit 1
